
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recent Strategic AI Initiatives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles for the D3 visualization */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            overflow: hidden; /* Prevent scrollbars on the body */
        }

        .node rect {
            stroke-width: 1.5px;
            transition: fill 0.3s, stroke 0.3s;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Stronger shadow */
        }

        .link {
            fill: none;
            stroke: #95a5a6; /* Silver/Gray for the link */
            stroke-width: 1.5px;
            stroke-dasharray: 4, 4; /* Dashed/dotted line for organic feel */
        }

        .node-text-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .collapse-button {
            fill: #f7f7f7;
            stroke: #7f8c8d;
            stroke-width: 1px;
            cursor: pointer;
        }

        .plus-minus {
            font-size: 14px;
            font-weight: bold;
            fill: #2c3e50;
            pointer-events: none;
        }
    </style>
</head>
<body class="p-4 flex flex-col h-screen">

    <!-- Header and Controls (Logo, Title, and Disclaimer) -->
    <div class="flex justify-between items-center mb-4">
        <!-- Left side: Title and Disclaimer stacked -->
        <div class="flex flex-col">
            <div class="flex items-center space-x-3">
            <img src="https://enexem.com/wp-content/uploads/2025/09/Screenshot_2025-08-26_at_17.25.30-removebg-preview-orange-text-v2-1.png"
         alt="enexem-no-text-logo"
         style="width:5vw; height:auto; display:block;">

                <h1 class="text-2xl font-bold text-gray-800">  Recent UK Government Strategic AI Initiatives</h1>
            </div>
            <!-- Disclaimer Text -->
            <h3 class="text-xs text-red-500 italic mt-1 ml-16">
              &nbsp &nbsp &nbsp Disclaimer: External search results are opened in a new tab due to browser security restrictions.
            </h3>
        </div>
        
        <!-- Right side: Toggle Button -->
        <button id="toggle-sidebar" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150">
            Toggle Sidebar
        </button>
    </div>
    
    <div class="flex flex-grow w-full space-x-4">
        <!-- Tree Container -->
        <div id="tree-container" class="w-full border border-gray-300 rounded-xl shadow-lg bg-white overflow-hidden flex-shrink transition-all duration-300">
            <!-- SVG will be appended here -->
        </div>

        <!-- Sidebar (Initially hidden, 40% width when visible) -->
        <div id="sidebar" class="w-2/5 bg-gray-50 p-4 border border-gray-300 rounded-xl shadow-lg flex-shrink-0 hidden overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Node Details</h2>
            
            <!-- Node Details Display -->
            <div id="node-details" class="mb-6">
                <p class="text-gray-500 italic">Click a node in the tree to view its static details here.</p>
            </div>

            <!-- External Search Section -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">External Search (Google)</h3>
                
                <input type="text" id="search-input" placeholder="Query for node context..." class="w-full p-2 border rounded-lg text-sm mb-2 bg-white" readonly>
                
                <button id="search-button" class="w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 flex items-center justify-center space-x-2" disabled>
                    <span id="button-text">Search Google for Current Node</span>
                </button>
                
                <p id="search-info" class="text-xs text-gray-500 mt-2">
                    Click the button to open a new tab with Google results for the selected node, including its key context points.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Tooltip (for hover metadata) -->
    <div id="tooltip" class="absolute bg-gray-800 text-white p-3 text-xs rounded-lg shadow-xl border border-gray-700 pointer-events-none opacity-0 transition duration-200 z-50 max-w-sm"></div>

    <script type="text/javascript">
        // Data structure for the D3 tree visualization, augmented with details from the provided document.
        const treeData = {
            "name": "UK AI Opportunities Action Plan (AIOAP) Implementation",
            "metadata": {
                "Leadership": "Led by Matt Clifford CBE, Chair of the Advanced Research and Invention Agency (ARIA).",
                "Total Recommendations": "50 wide-ranging recommendations.",
                "Status": "Accepted all 50 recommendations",
                "Publication Date": "January 2025",
                "Strategic Goal": "Accelerate AI adoption and enhance infrastructure and talent.",
                "Economic Impact": "Aims to add up to £47 billion annually to the UK economy."
            },
            "children": [
                {
                    "name": "Pillar I: Investing in the Foundations of AI",
                    "metadata": {
                        "Focus": "Establishing world-class computing, data infrastructure, talent pipelines, and safety frameworks.",
                        "Recommendations Covered": "Recs 1–19, 29",
                        "Strategic Velocity": "High, focused on capital investment (compute) and strategic partnership (AISI)."
                    },
                    "children": [
                        {
                            "name": "Compute, Infrastructure, and Sustainability",
                            "metadata": { "Section Focus": "Securing sufficient, secure, and sustainable AI compute capacity." },
                            "children": [
                                {
                                    "name": "Recs 1 & 2: Infrastructure Strategy and Investment",
                                    "metadata": {
                                        "Commitment": "Setting out a long-term plan for the UK's AI infrastructure needs, backed by a 10-year investment commitment."
                                    }
                                },
                                {
                                    "name": "Rec 3: Expanding the AI Research Resource (AIRR)",
                                    "metadata": {
                                        "Capacity Goal": "At least 20 times expansion by 2030.",
                                        "Funding": "Over £350 million committed by 2030 for expansion of AIRR.",
                                        "Key Assets": "Isambard-AI (UK’s most powerful public compute) and Dawn supercomputers are operational.",
                                        "Cloud Procurement": "Up to £250 million deployed for acquiring additional cloud-based capacity."
                                    }
                                },
                                {
                                    "name": "Rec 4: AI Growth Zones (AIGZs)",
                                    "metadata": {
                                        "Status": "Four initial AIGZ sites have been announced.",
                                        "Incentives": "Enhanced access to power and streamlined planning approval support.",
                                        "Example Project": "South Wales AIGZ involves potential £10 billion private investment (Microsoft/Vantage)."
                                    }
                                },
                                {
                                    "name": "Rec 5: Mitigating Sustainability and Security Risks",
                                    "metadata": {
                                        "Body": "AI Energy Council (AEC) established and operational.",
                                        "Mandate": "Resolve grid access (accelerated connection) and explore sustainable power solutions within AIGZs.",
                                        "Delivery Risk": "Procedural delivery risk associated with resolving energy grid constraints remains a key challenge."
                                    }
                                }
                            ]
                        }
                        ,{
                            "name": "Data Assets and Research Investment",
                            "metadata": { "Section Focus": "Unlocking high-value data assets and driving fundamental AI research." },
                            "children": [
                                {
                                    "name": "Rec 7: Rapidly Identify High-Impact Public Datasets",
                                    "metadata": {
                                        "Initiative": "National Data Library (NDL) creation and establishment.",
                                        "Core Objective": "Responsibly, securely, and ethically unlock public sector data for AI research.",
                                        "Mandate": "Identify at least five high-impact public datasets."
                                    }
                                },
                                {
                                    "name": "Recs 12 & 13: Incentivising Private Data and Data Quality",
                                    "metadata": {
                                        "Action 12": "Commitment to actively incentivise and reward industry/researchers to unlock private datasets.",
                                        "Action 13": "Committed to financing the creation of new high-value public datasets and enhancing data quality."
                                    }
                                },
                                {
                                    "name": "Recs 15 & 16: Major Research Investment and Innovation Hubs",
                                    "metadata": {
                                        "Funding": "£100 million AI Research Investment via UKRI.",
                                        "EPSRC Hubs": "£80 million allocated for nine new EPSRC Research Hubs focusing on complex problems (e.g., causality in healthcare)."
                                    }
                                }
                            ]
                        },
                        {
                            "name": "Talent, Skills, and Safety",
                            "metadata": { "Section Focus": "Cultivating, attracting, and retaining elite AI talent and enabling safe development." },
                            "children": [
                                {
                                    "name": "Rec 18: Flagship AI Scholarship Programme",
                                    "metadata": {
                                        "Status": "Launched: The Spärck AI Scholarships have been announced and funded.",
                                        "Detail": "Provides full funding for master’s degrees for at least 100 exceptional students across nine leading UK universities."
                                    }
                                },
                                {
                                    "name": "Rec 19: Lifelong Skills Programme",
                                    "metadata": {
                                        "Resource": "Employer AI Adoption Checklist published by Skills England.",
                                        "Goal": "Emphasizing opportunities for workers to reskill and assessing AI skills readiness."
                                    }
                                },
                                {
                                    "name": "Recs 20, 21, & 22: Attracting Elite Talent",
                                    "metadata": {
                                        "Mechanism": "Leveraging and expanding fast-track immigration pathways (HPI visa).",
                                        "Programmes": "Turing AI Global Fellowships (£25 million) and Encode: AI for Science Fellowships launched."
                                    }
                                },
                                {
                                    "name": "Rec 29: Supporting the AI Assurance Ecosystem",
                                    "metadata": {
                                        "Central Body": "AI Safety Institute (AISI) running systemic AI safety grants programmes.",
                                        "Guidance": "Introductory guide 'Introduction to AI Assurance' published to operationalise regulatory principles."
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "Pillar II: Driving Cross-Economy AI Adoption",
                    "metadata": {
                        "Focus": "Scaling AI deployment, bureaucratic reform, and transforming public services.",
                        "Recommendations Covered": "Recs 20–39.",
                        "Systemic Risk": "The most significant systemic risk to AIOAP is the procedural delivery risk associated with these bureaucratic reforms."
                    },
                    "children": [
                        {
                            "name": "Regulatory Environment and Flexibility",
                            "metadata": { "Section Focus": "Maintaining a principles-based framework and fostering innovation." },
                            "children": [
                                {
                                    "name": "Recs 25, 26, & 27: Empowering Regulators",
                                    "metadata": {
                                        "Principle": "Sectoral regulators interpret and apply high-level AI principles.",
                                        "Support": "Supported by the Digital Regulation Cooperation Forum (DRCF) for coordination."
                                    }
                                },
                                {
                                    "name": "Rec 28: AI Growth Labs (AIGL)",
                                    "metadata": {
                                        "Status": "Consultation Phase (Call for Evidence underway).",
                                        "Mechanism": "Designed as a cross-economy sandbox granting time-limited regulatory exemptions ('sandbox pilots')."
                                    }
                                }
                            ]
                        },
                        {
                            "name": "Public Sector Transformation (Skills and Procurement)",
                            "metadata": { "Section Focus": "Addressing the digital skills gap and radically changing procurement to leverage government buying power." },
                            "children": [
                                {
                                    "name": "Rec 14: Addressing the Digital Skills Gap (Civil Service)",
                                    "metadata": {
                                        "Resources": "GDS launched the Artificial Intelligence (AI) Playbook for the UK Government.",
                                        "Initiatives": "Internal skills initiatives such as One Big Thing (OBT) 2023 programme."
                                    }
                                },
                                {
                                    "name": "Rec 38: PILOT - Multi-Stage Procurement",
                                    "metadata": {
                                        "Action": "Scoping underway for a faster, multi-stage, gated AI procurement process.",
                                        "Goal": "Enable easy and quick access to small-scale funding for pilots.",
                                        "Update Due": "Critical procedural update scheduled for Autumn 2025."
                                    }
                                },
                                {
                                    "name": "Rec 39: SCALE - Scaling Service",
                                    "metadata": {
                                        "Status": "Agreed/Scoping underway.",
                                        "Support": "Function actively supported by the scaling capability within Incubator.AI."
                                    }
                                }
                            ]
                        },
                        {
                            "name": "Private Sector Adoption and IP Clarity",
                            "metadata": { "Section Focus": "Fostering wider private sector adoption and resolving Intellectual Property conflicts." },
                            "children": [
                                {
                                    "name": "Rec 47: Competitive Text and Data Mining Regime (TDM)",
                                    "metadata": {
                                        "Policy Detail": "Consultation closed. Preferred approach introduces a TDM exception with an express opt-out mechanism for rights holders.",
                                        "Goal": "Balance innovation with creator protections."
                                    }
                                },
                                {
                                    "name": "Rec 48: Sector Opportunities (AI Champions)",
                                    "metadata": {
                                        "Action": "Appointment of AI Champions (e.g., Prof. Chris Dungey for industry/manufacturing).",
                                        "Sectors": "Key sectors include life sciences, financial services, industry/manufacturing."
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "Pillar III: Positioning the UK as an AI Maker",
                    "metadata": {
                        "Focus": "Building sovereign AI capabilities and maximizing influence over frontier AI advancements.",
                        "Recommendations Covered": "Recs 40–50.",
                        "Strategic Velocity": "High, focused on the technology supply side."
                    },
                    "children": [
                        {
                            "name": "Sovereign Capability and Influence",
                            "metadata": { "Section Focus": "Ensuring UK has 'true national champions at critical layers of the AI stack'." },
                            "children": [
                                {
                                    "name": "Recs 40, 41, & 42: Sovereign AI Unit",
                                    "metadata": {
                                        "Status": "Established and Operational.",
                                        "Funding": "Backed by up to £500 million.",
                                        "Role": "Announced role as a 'first customer' for promising UK hardware start-ups to accelerate sovereign hardware development."
                                    }
                                },
                                {
                                    "name": "Rec 45: Strategic Partnerships",
                                    "metadata": {
                                        "Partnership": "Memorandum of Understanding (MoU) signed with OpenAI.",
                                        "Date": "Signed July 2025.",
                                        "Scope": "Aims to accelerate AI-driven growth and deepen government knowledge of evolving AI capabilities."
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        // --- D3 Global Variables and Configuration ---
        const PADDING = 10;
        const NODE_WIDTH = 250; 
        const NODE_LINE_HEIGHT = 18;
        const MARGIN = { top: 50, right: 100, bottom: 50, left: 100 };
        const TOOLTIP_ID = 'tooltip';
        const SIDEBAR_ID = 'sidebar';
        const TREE_CONTAINER_ID = 'tree-container';
        
        let svg, g, zoom, root, tree, i = 0;
        let containerWidth, containerHeight;
        let duration = 750;
        
        // --- SPACING ADJUSTMENT ---
        const VERTICAL_NODE_SPACING = 60; 
        const HORIZONTAL_NODE_SEPARATION = 350; 

        // Lighter color scale based on depth
        const depthColors = d3.scaleOrdinal()
            .domain([0, 1, 2, 3, 4]) 
            .range(["#D2B4DE", "#A9D08E", "#F9E79F", "#E9C46A", "#C3C3E5"]); 


        // --- Layout and Sizing Functions ---

        /**
         * Calculates the minimum required height for a node rectangle based on its content (name only).
         */
        function calculateNodeHeight(d) {
            return 80;
        }

        /**
         * Recursively sets the position (x) for each node to prevent vertical overlap,
         * based on the dynamically calculated height.
         */
        function layout(d, y0) {
            const h = calculateNodeHeight(d);
            d.y0 = y0;
            d.x = y0 + h / 2; // Center the node vertically at its new calculated position

            y0 += h + VERTICAL_NODE_SPACING; 

            if (d.children) {
                for (let i = 0; i < d.children.length; ++i) {
                    y0 = layout(d.children[i], y0);
                }
            }

            // After children are laid out, correct the parent's position to be the average of its children
            if (d.children && d.children.length > 0) {
                const firstChildY = d.children[0].x;
                const lastChildY = d.children[d.children.length - 1].x;
                d.x = (firstChildY + lastChildY) / 2;
            }

            // Store the calculated height for rendering
            d.height = h;

            return y0; // Return the next available starting Y position
        }

        // --- Tooltip Functions (Hover) ---

        function showTooltip(event, d) {
            const tooltip = d3.select(`#${TOOLTIP_ID}`);
            const metadata = d.data.metadata;

            if (!metadata || Object.keys(metadata).length === 0) {
                tooltip.transition().duration(200).style("opacity", 0);
                return;
            }

            let html = `<div class="font-bold mb-1 border-b border-gray-600 pb-1">${d.data.name}</div>`;
            html += '<div class="space-y-0.5 mt-1">';
            
            for (const [key, value] of Object.entries(metadata)) {
                let displayValue = (typeof value === 'string' || value instanceof String) ? value : JSON.stringify(value);
                
                if (displayValue.length > 100) {
                    displayValue = displayValue.substring(0, 100) + '... (Click for full detail in sidebar)';
                }

                html += `<p><strong class="font-medium text-blue-300">${key}:</strong> ${displayValue}</p>`;
            }
            html += '</div>';

            tooltip.html(html);

            const [x, y] = d3.pointer(event, document.body);
            const tooltipNode = tooltip.node();
            const tooltipRect = tooltipNode.getBoundingClientRect();

            let left = x + 15;
            let top = y - 10;
            
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = x - tooltipRect.width - 15;
            }

            if (top < 10) {
                top = 10;
            }

            tooltip.style("left", `${left}px`)
                   .style("top", `${top}px`);

            tooltip.transition().duration(200).style("opacity", 1);
        }

        function hideTooltip() {
            d3.select(`#${TOOLTIP_ID}`).transition().duration(200).style("opacity", 0);
        }

        // --- Search Logic (External Link) ---
        
        /**
         * Constructs a Google search URL and opens it in a new window.
         * @param {Object} nodeData The full data object of the node to search for.
         */
        function handleExternalSearch(nodeData) {
            let fullQuery = `UK AI policy ${nodeData.name}`;

            // Add metadata context to the query string (first 10 words of each value)
            if (nodeData.metadata) {
                for (const value of Object.values(nodeData.metadata)) {
                    // Only add the first 10 words of each metadata value to keep the query concise but contextual
                    const contextSnippet = String(value).split(' ').slice(0, 10).join(' ');
                    fullQuery += ` ${contextSnippet}`;
                }
            }
            
            const query = encodeURIComponent(fullQuery);
            const googleUrl = `https://www.google.com/search?q=${query}`;
            window.open(googleUrl, '_blank');
        }


        // --- Sidebar Functions (Click) ---
        
        function updateSidebar(data) {
            const sidebar = document.getElementById(SIDEBAR_ID);
            const detailsContainer = document.getElementById('node-details');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            
            // 1. Update Node Details (Static Metadata)
            let detailsHtml = `<h3 class="text-xl font-semibold text-gray-800 mb-3">${data.name}</h3>`;

            if (data.metadata && Object.keys(data.metadata).length > 0) {
                detailsHtml += '<div class="space-y-1 text-sm text-gray-700 border-t pt-3 mt-3">';
                for (const [key, value] of Object.entries(data.metadata)) {
                    detailsHtml += `<p><strong class="font-medium text-gray-600">${key}:</strong> ${value}</p>`;
                }
                detailsHtml += '</div>';
            } else {
                 detailsHtml += '<p class="text-sm text-gray-500 italic">No detailed metadata available for this node.</p>';
            }
            
            detailsContainer.innerHTML = detailsHtml;

            // 2. Update Search Box and Button for Google Search
            searchInput.value = `Search query: UK AI policy ${data.name} + metadata context`;
            searchButton.disabled = false;
            
            // Attach the external search function, passing the full node data
            searchButton.onclick = () => handleExternalSearch(data); 

            // 3. Ensure the sidebar is visible if details are being updated
            if (sidebar.classList.contains('hidden')) {
                toggleSidebar();
            }
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById(SIDEBAR_ID);
            const treeContainer = document.getElementById(TREE_CONTAINER_ID);
            const isHidden = sidebar.classList.contains('hidden');

            if (isHidden) {
                // Show sidebar (60% tree, 40% sidebar)
                sidebar.classList.remove('hidden');
                treeContainer.classList.remove('w-full');
                treeContainer.classList.add('w-3/5');
            } else {
                // Hide sidebar (100% tree)
                sidebar.classList.add('hidden');
                treeContainer.classList.remove('w-3/5');
                treeContainer.classList.add('w-full');
            }
            
            // Re-run the update function to recalculate D3 dimensions
            setTimeout(() => {
                resizeCanvas();
                update(root);
                centerRootNode(); 
            }, 300); // Wait for CSS transition to finish
        }

        /**
         * Centers the root node horizontally in the current viewport of the SVG.
         */
        function centerRootNode() {
            if (!svg || !zoom || !root) return;
            
            const container = d3.select("#tree-container");
            containerWidth = container.node().clientWidth;

            const initialScale = 1;
            
            const zoomTranslateX = (containerWidth / 2) - (NODE_WIDTH / 2) - MARGIN.left;
            const zoomTranslateY = 0; 

            svg.transition()
                .duration(500)
                .call(zoom.transform, d3.zoomIdentity.translate(zoomTranslateX, zoomTranslateY).scale(initialScale));
        }

        // --- Core D3 Setup and Functions ---

        function resizeCanvas() {
            const container = d3.select("#tree-container");
            containerWidth = container.node().clientWidth;
            containerHeight = container.node().clientHeight;

            svg.attr("width", containerWidth).attr("height", containerHeight);
            tree.size([containerHeight - MARGIN.top - MARGIN.bottom, containerWidth - MARGIN.left - MARGIN.right]);
        }

        // Initialize and set up the SVG container
        function initialize() {
            const container = d3.select("#tree-container");
            containerWidth = container.node().clientWidth;
            containerHeight = container.node().clientHeight;

            // 1. Create the main SVG element
            svg = container.append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight);

            // 2. Setup Zoom/Pan behavior
            zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => g.attr("transform", event.transform));

            svg.call(zoom);

            // 3. Main group element for the tree, offset by margin/starting position
            g = svg.append("g")
                .attr("transform", `translate(${MARGIN.left}, 0)`);

            // 4. Create the hierarchy (tree structure)
            root = d3.hierarchy(treeData, d => d.children);
            root.x0 = containerHeight / 2;
            root.y0 = 0;

            // 5. Tree layout generator (Horizontal orientation: x is vertical, y is horizontal)
            tree = d3.tree()
                .size([containerHeight - MARGIN.top - MARGIN.bottom, containerWidth - MARGIN.left - MARGIN.right]);

            // Initial Collapse Logic (Collapse all nodes except root)
            if (root.children) {
                root.children.forEach(collapse);
            }
            
            // Initial drawing
            update(root);

            // Center the initial view
            centerRootNode(); 

            // Handle window resizing
            window.addEventListener('resize', () => {
                resizeCanvas();
                update(root);
                centerRootNode(); 
            });
            
            // Attach event listener to the toggle button
            document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
        }

        // Collapse function
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }

        // Toggle children on click
        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }

        // The main update function
        function update(source) {
            // 1. Calculate positions using D3's tree layout
            const rootNode = tree(root);
            let nodes = rootNode.descendants();
            let links = rootNode.links();

            // 2. Re-layout nodes based on custom height calculation to prevent vertical overlap
            layout(root, 0);

            // 3. Normalize for fixed depth (horizontal spacing)
            nodes.forEach(d => {
                d.y = d.depth * HORIZONTAL_NODE_SEPARATION; 
            });


            // --- Node Group (Enter, Update, Exit) ---

            const node = g.selectAll('g.node')
                .data(nodes, d => d.id || (d.id = ++i));

            // Enter any new nodes at the parent's previous position.
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on('click', (event, d) => {
                    click(event, d);
                    updateSidebar(d.data); // Update sidebar on click with local metadata
                })
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

            // Add the rectangle (the actual node shape)
            nodeEnter.append('rect')
                .attr('rx', 8)
                .attr('ry', 8)
                .attr('width', NODE_WIDTH)
                .attr('height', d => d.height)
                .attr('x', 0) 
                .attr('y', d => -d.height / 2) 
                .style('fill', d => depthColors(d.depth))
                .style('stroke', d => d3.color(depthColors(d.depth)).darker(0.3)); 

            // --- Text Content (Name only) ---

            // Append a foreign object to handle complex HTML layout and text wrapping, centered
            nodeEnter.append("foreignObject")
                .attr("width", NODE_WIDTH - PADDING * 2)
                .attr("height", d => d.height - PADDING)
                .attr("x", PADDING)
                .attr("y", d => -d.height / 2 + PADDING / 2) 
                .append("xhtml:div")
                .style("height", "100%")
                .style("overflow-y", "hidden")
                .html(d => {
                    // Centered text content
                    return `<div class='node-text-name' style='line-height: ${NODE_LINE_HEIGHT}px; overflow-wrap: break-word;'>${d.data.name}</div>`;
                });


            // --- Collapse/Expand Button ---

            // Button (circle)
            nodeEnter.append('circle')
                .attr('class', 'collapse-button')
                .attr('r', 6)
                .attr('cy', 0)
                .attr('cx', NODE_WIDTH + 8) 
                .style('opacity', d => d._children || d.children ? 1 : 0);

            // Plus/Minus Text (inside the button)
            nodeEnter.append('text')
                .attr('class', 'plus-minus')
                .attr('dy', 5)
                .attr('dx', NODE_WIDTH + 8)
                .attr('text-anchor', 'middle')
                .text(d => d._children ? '+' : d.children ? '−' : ''); 


            // Update the nodes (merging enter and update selections)
            const nodeUpdate = node.merge(nodeEnter)
                .transition()
                .duration(duration)
                .attr('transform', d => `translate(${d.y},${d.x})`);

            // Update Rect, Foreign Object, and Collapse Button
            nodeUpdate.select('rect')
                .attr('width', NODE_WIDTH)
                .attr('height', d => d.height)
                .attr('y', d => -d.height / 2)
                .style('fill', d => depthColors(d.depth))
                .style('stroke', d => d3.color(depthColors(d.depth)).darker(0.3));

            nodeUpdate.select('foreignObject')
                .attr("height", d => d.height - PADDING)
                .attr("y", d => -d.height / 2 + PADDING / 2);

            nodeUpdate.select('.collapse-button')
                .style('opacity', d => d._children || d.children ? 1 : 0)
                .attr('cx', NODE_WIDTH + 8);

            nodeUpdate.select('.plus-minus')
                .attr('dx', NODE_WIDTH + 8)
                .text(d => d._children ? '+' : d.children ? '−' : '');


            // Exit nodes: Transition to the parent's position and remove them.
            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr('transform', d => `translate(${source.y},${source.y})`)
                .remove();

            nodeExit.select('rect').attr('width', 0).attr('height', 0);
            nodeExit.select('.plus-minus').style('fill-opacity', 0);


            // --- Links (Enter, Update, Exit) ---

            const link = g.selectAll('path.link')
                .data(links, d => d.target.id);

            // Enter new links at the parent's previous position.
            const linkEnter = link.enter().insert('path', "g")
                .attr("class", "link")
                .attr('d', d => {
                    const o = { x: source.x0, y: source.y0 };
                    return d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x)
                        ({ source: o, target: o });
                });

            // Update existing links.
            link.merge(linkEnter).transition()
                .duration(duration)
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x)
                );

            // Exit any old links.
            link.exit().transition()
                .duration(duration)
                .attr('d', d => {
                    const o = { x: source.x, y: source.y };
                    return d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x)
                        ({ source: o, target: o });
                })
                .remove();

            // Store the old positions for transition.
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Start the visualization when the window loads
        window.onload = initialize;

    </script>

    <script>
function sendHeight() {
    const height = document.documentElement.scrollHeight;
    window.parent.postMessage({ type: 'setHeight', height }, '*');
}

// Send height on load
window.addEventListener('load', sendHeight);

// Send height on window resize
window.addEventListener('resize', sendHeight);

// Optional: send height after D3 tree updates
function updateTreeHeight() {
    sendHeight();
}
</script>

    
</body>
</html>
